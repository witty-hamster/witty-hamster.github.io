import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as e,e as a,o as t}from"./app-rM1WJOZm.js";const n={};function l(h,i){return t(),e("div",null,i[0]||(i[0]=[a(`<h1 id="redis-踩坑记录" tabindex="-1"><a class="header-anchor" href="#redis-踩坑记录"><span>Redis 踩坑记录</span></a></h1><h2 id="_1-redisson客户端超时问题" tabindex="-1"><a class="header-anchor" href="#_1-redisson客户端超时问题"><span>1. redisson客户端超时问题</span></a></h2><p><strong>具体错误信息：</strong></p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sh"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Caused</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> by:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> org.redisson.client.RedisTimeoutException:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Command</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> still</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hasn&#39;t been written into connection! Check connection with Redis node: r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com/192.168.108.252:6379 for TCP packet drops. Try to increase nettyThreads setting.  Node source: NodeSource [slot=0, addr=null, redisClient=null, redirect=null, entry=null], connection: RedisConnection@1537994324 [redisClient=[addr=redis://r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com:6379], channel=[id: 0xce0299d3, L:/10.0.0.17:43610 - R:r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com/192.168.108.252:6379], currentCommand=CommandData [promise=java.util.concurrent.CompletableFuture@4e47fc5c[Completed exceptionally], command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1], codec=org.redisson.client.codec.ByteArrayCodec], usage=1], command: (GET), params: [[49, 50, 58, 55, 48, 50, 50, 50, 53, 102, ...]] after 3 retry attempts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>[!WARNING]</p><p>上如错误日志中，✨✨✨最最最重要的错误问题 <code>command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1]</code>，也就是对于 redis list 结构数据，使用了 <code>LRANGE [key...] 0 -1</code> 查询了全量的数据，从而造成了慢查询，导致服务资源被占用，Netty 连接耗尽，进一步导致了客户端超时现象的产生，使其他的命令发不出去。</p></blockquote><p><strong>错误信息分析：</strong></p><ul><li><p>核心问题：Redisson 客户端与阿里云 Redis 实例通信时发生了超时</p></li><li><p>错误关键点分析：</p><ul><li><code>Command still hasn&#39;t been written into connection!</code> ：说明命令卡在客户端未写入网络连接。不是 Redis 响应慢，而是命令连发送都没有发出去</li></ul></li><li><p>什么情况下会造成如上的错误呢？</p><ul><li>Netty 线程阻塞</li><li>系统负载高</li><li>网络问题</li><li>连接池耗尽</li></ul></li><li><p><code>Try to increase nettyThreads setting</code> ：表示 Redisson 提示你增加 <code>nettyThreads</code> ，说明可能是 Netty 工作线程不够用了</p></li><li><p><code>command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1]</code>：表示在使用 redis 客户端查询时，使用了 <code>LRANGE [key...] 0 -1</code> 来全量读取整个列表。如果这里 list 很大（几万条以上），就会导致 Redis 响应慢、客户端发送命令时被阻塞（因为连接被占用），从而导致其他命令排队，最终造成超时</p></li></ul><p><strong>解决方案：</strong></p><ul><li><p>增加 <code>nettyThreads</code></p><ul><li><p>Redisson 使用 Netty 做网络通信，默认 <code>nettyThreads = 32</code>。如果遇到高并发或处理慢时，线程可能被占满。</p></li><li><p>调整方式：在 Redisson 配置中增加线程数</p><blockquote><p>调整建议：nettyThreads = min(64, 2 * CPU 核数)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> config </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setNettyThreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 建议设置为 64 或更高，根据服务器的 CPU 核数调整</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>检查连接池配置</p><ul><li><p>如果连接池太小，也会导致命令排队等待连接</p></li><li><p>调整方式：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">useSingleServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setConnectionPoolSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 默认 64，可以增大到 128</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setConnectionMinimumIdleSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">24</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 保持一定空闲连接</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setIdleConnectionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 空闲连接超时（ms）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setConnectTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 连接超时</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // 命令超时时间，避免无限等待</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setRetryAttempts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     // 重试次数</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setRetryInterval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     // 重试间隔</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setPingConnectionInterval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 保持连接活跃，防止中间设备断连，没 30000ms ping 一次 redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>检查系统资源</p><ul><li>CPU 使用率</li><li>内存是否 OOM</li><li>网络带宽、丢包情况</li></ul></li><li><p>检查 Redis 实例状态</p><blockquote><p>阿里云 Redis 控制台</p></blockquote><ul><li>资源使用情况（CPU、内存、带宽等）</li><li>慢日志</li><li>QPS 是否突增</li><li>是否存在网络抖动</li></ul></li><li><p>避免大 Key 操作</p><ul><li>例如错误中的 <code>LRANGE [key...] 0 -1</code></li><li>调整建议： <ul><li>分页读取：<code>LRANGE key 0 20</code></li><li>使用 <code>SCAN</code> 类命令或结构优化</li></ul></li></ul></li><li><p>升级 Redisson 版本</p><ul><li>老版本可能存在 Netty 或连接管理的 BUG</li><li>建议使用 3.16 + 或 3.23 +</li></ul></li></ul>`,9)]))}const k=s(n,[["render",l]]),p=JSON.parse(`{"path":"/posts/%E6%94%B6%E9%9B%86%E7%AE%B1/Redis%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95.html","title":"Redis踩坑记录","lang":"zh-CN","frontmatter":{"title":"Redis踩坑记录","icon":"cil:dog","date":"2025-11-13T00:00:00.000Z","order":1,"category":["收集箱"],"tags":["redis"],"star":true,"sticky":false,"description":"Redis 踩坑记录 1. redisson客户端超时问题 具体错误信息： [!WARNING] 上如错误日志中，✨✨✨最最最重要的错误问题 command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1]，也就是对于 redis list 结构数据...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis踩坑记录\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-11-13T00:00:00.000Z\\",\\"dateModified\\":\\"2025-11-13T10:22:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Hamster\\",\\"url\\":\\"https://witty-hamster.github.io\\"}]}"],["meta",{"property":"og:url","content":"https://witty-hamster.github.io/posts/%E6%94%B6%E9%9B%86%E7%AE%B1/Redis%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95.html"}],["meta",{"property":"og:title","content":"Redis踩坑记录"}],["meta",{"property":"og:description","content":"Redis 踩坑记录 1. redisson客户端超时问题 具体错误信息： [!WARNING] 上如错误日志中，✨✨✨最最最重要的错误问题 command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1]，也就是对于 redis list 结构数据..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-13T10:22:02.000Z"}],["meta",{"property":"article:tag","content":"redis"}],["meta",{"property":"article:published_time","content":"2025-11-13T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-13T10:22:02.000Z"}]]},"git":{"createdTime":1754290562000,"updatedTime":1763029322000,"contributors":[{"name":"guodong","username":"guodong","email":"cuiguodong_2012@163.com","commits":4,"url":"https://github.com/guodong"}]},"readingTime":{"minutes":2.81,"words":842},"filePathRelative":"posts/收集箱/Redis踩坑记录.md","excerpt":"\\n<h2>1. redisson客户端超时问题</h2>\\n<p><strong>具体错误信息：</strong></p>\\n<div class=\\"language-sh line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"sh\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code class=\\"language-sh\\"><span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">Caused</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> by:</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> org.redisson.client.RedisTimeoutException:</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> Command</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> still</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> hasn't been written into connection! Check connection with Redis node: r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com/192.168.108.252:6379 for TCP packet drops. Try to increase nettyThreads setting.  Node source: NodeSource [slot=0, addr=null, redisClient=null, redirect=null, entry=null], connection: RedisConnection@1537994324 [redisClient=[addr=redis://r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com:6379], channel=[id: 0xce0299d3, L:/10.0.0.17:43610 - R:r-2zegymkgsoz076kik7.redis.rds.aliyuncs.com/192.168.108.252:6379], currentCommand=CommandData [promise=java.util.concurrent.CompletableFuture@4e47fc5c[Completed exceptionally], command=(LRANGE), params=[[73, 65, 77, 58, 108, 111, 103, 105, 110, 95, ...], 0, -1], codec=org.redisson.client.codec.ByteArrayCodec], usage=1], command: (GET), params: [[49, 50, 58, 55, 48, 50, 50, 50, 53, 102, ...]] after 3 retry attempts</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}`);export{k as comp,p as data};
